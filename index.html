<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>PsychoJS Umfrage â€“ mit Google Sheets Speicherung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background-color: #111;
    color: #eee;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 50px;
  }
  canvas { display: none; }
  button {
    background-color: #1e1e1e;
    color: #fff;
    border: 1px solid #555;
    padding: 12px 28px;
    border-radius: 10px;
    font-size: 18px;
    cursor: pointer;
  }
  button:hover { background-color: #333; }
</style>
</head>
<body>
<h1>PsychoJS Umfrage</h1>
<p>Klicke auf â€žStartâ€œ, um zu beginnen.</p>
<button id="startBtn">Start</button>

<script>
let started = false;
let lostFocusCount = 0;
let data = {};

// Wenn Fenster Fokus verliert
document.addEventListener("visibilitychange", () => {
  if (document.hidden && started) {
    lostFocusCount++;
  }
});

document.getElementById("startBtn").addEventListener("click", () => {
  document.getElementById("startBtn").remove();
  startSurvey();
});

function startSurvey() {
  started = true;
  data.startedAt = new Date().toISOString();
  showQuestion(0);
}

const questions = [
  { text: "Wie zufrieden bist du heute?", scale: [1,2,3,4,5] },
  { text: "Wie konzentriert warst du wÃ¤hrend der Umfrage?", scale: [1,2,3,4,5] },
  { text: "Wie mÃ¼de fÃ¼hlst du dich?", scale: [1,2,3,4,5] }
];

function showQuestion(i) {
  if (i >= questions.length) {
    finish();
    return;
  }
  const q = questions[i];
  document.body.innerHTML = `
    <h1>Frage ${i+1} von ${questions.length}</h1>
    <p>${q.text}</p>
    ${q.scale.map(v => `<button onclick="saveAnswer(${i}, ${v})">${v}</button>`).join(" ")}
  `;
}

function saveAnswer(i, val) {
  data[`q${i+1}`] = val;
  showQuestion(i + 1);
}

// === Google Sheets Integration ===
const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwkp-eKXcL6yihE_kGlY7_-capIvF26UuHM9JrVtk68v4NoZKkCAS5cPNnZamQ1dfOFzQ/exec";

function sendDataToGoogle(data) {
  fetch(GOOGLE_APPS_SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).catch(err => console.error("Send error:", err));
}

const urlParams = new URLSearchParams(window.location.search);
const participantID = urlParams.get("vp") || "anon";

function finish(reason = null) {
  data.finishedAt = new Date().toISOString();
  data.lostFocusCount = lostFocusCount;
  data.participant = participantID;
  if (reason) data.screenout_reason = reason;

  // ðŸ”¹ Sende an Google Sheets
  sendDataToGoogle(data);

  // ðŸ”¹ Lokaler CSV-Download als Backup
  const keys = Object.keys(data);
  const vals = keys.map(k => JSON.stringify(data[k] ?? ''));
  const csv = keys.join(',') + '\n' + vals.join(',');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'survey_data.csv';
  a.click();

  document.body.innerHTML = `
    <h1>Danke!</h1>
    <p>Deine Antworten wurden gespeichert.</p>
    ${reason ? `<p>Beendigungsgrund: ${reason}</p>` : ""}
    <button onclick="location.reload()">Neu starten</button>
  `;
}
</script>
</body>
</html>
